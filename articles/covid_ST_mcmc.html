<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>COVID-19 MCMC (Space-time) • fdmr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="COVID-19 MCMC (Space-time)">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fdmr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutorials" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutorials</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutorials">
<li><h6 class="dropdown-header" data-toc-skip>Getting started</h6></li>
    <li><a class="dropdown-item" href="../articles/getting_started.html">Installation</a></li>
    <li><a class="dropdown-item" href="../articles/data_preprocessing.html">Data pre-processing</a></li>
    <li><a class="dropdown-item" href="../articles/expected_data_structure.html">Expected data structure</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>End to end tutorials</h6></li>
    <li><a class="dropdown-item" href="../articles/decision_tree.html">How to choose how to model</a></li>
    <li><a class="dropdown-item" href="../articles/simulation_gaussian_data.html">Simulation Tutorial (Gaussian data)</a></li>
    <li><a class="dropdown-item" href="../articles/simulation_poisson_data.html">Simulation Tutorial (Poisson data)</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Shiny apps</h6></li>
    <li><a class="dropdown-item" href="../articles/meshbuilder.html">Mesh building</a></li>
    <li><a class="dropdown-item" href="../articles/modelbuilder.html">Model builder</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>In depth tutorials</h6></li>
    <li><a class="dropdown-item" href="../articles/covid.html">COVID-19</a></li>
    <li><a class="dropdown-item" href="../articles/covid_mcmc.html">COVID-19 MCMC</a></li>
    <li><a class="dropdown-item" href="../articles/covid_ST_mcmc.html">COVID-19 MCMC (Space-time)</a></li>
    <li><a class="dropdown-item" href="../articles/hydro.html">Hydrology</a></li>
    <li><a class="dropdown-item" href="../articles/priors.html">Priors exploration</a></li>
    <li><a class="dropdown-item" href="../articles/ohc_tutorial.html">Ocean heat content mapping</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>FAQ</h6></li>
    <li><a class="dropdown-item" href="../articles/inla_FAQ.html">INLA Crash FAQ</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://4dmodeller.github.io/4DM_Hackathon/">Hackathon</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/4DModeller/fdmr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>COVID-19 MCMC (Space-time)</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/4DModeller/fdmr/blob/main/vignettes/covid_ST_mcmc.Rmd" class="external-link"><code>vignettes/covid_ST_mcmc.Rmd</code></a></small>
      <div class="d-none name"><code>covid_ST_mcmc.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="modelling-covid-19-infection-across-england">Modelling COVID-19 infection across England<a class="anchor" aria-label="anchor" href="#modelling-covid-19-infection-across-england"></a>
</h2>
<p>In this tutorial we’ll cover some work on fitting a spatio-temporal
Bayesian hierarchical model (BHM) to predict the COVID-19 infection rate
across England.</p>
</div>
<div class="section level2">
<h2 id="study-aim-and-data-description">Study aim and data description<a class="anchor" aria-label="anchor" href="#study-aim-and-data-description"></a>
</h2>
<p>This study describes how to fit a spatio-temporal BHM to areal data
using Markov Chain Monte Carlo (MCMC) simulation method. The first thing
is to load all the packages used in the COVID-19 case study.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">INLA</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://www.inlabru.org" class="external-link">inlabru</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span></code></pre></div>
<p>The study region is mainland England, which is partitioned into 6789
neighbourhoods at the Middle Layer Super Output Area (MSOA) scale. The
infections data are the total reported number of COVID-19 cases in each
MSOA from Jan 8, 2022 to March 26, 2022. The shapefile of the study
region is a <code>SpatialPolygonsDataFrame</code>, which is used to map
the data. It stores the location, shape and attributes of geographic
features for the neighbourhoods.</p>
<div class="section level3">
<h3 id="installing-carbayesst">Installing CARBayesST<a class="anchor" aria-label="anchor" href="#installing-carbayesst"></a>
</h3>
<p>This tutorial requires the <a href="https://cran.r-project.org/web/packages/CARBayesST/index.html" class="external-link"><code>CARBayesST</code></a>
package which you may need to install before working through this
tutorial.</p>
</div>
<div class="section level3">
<h3 id="retrieving-and-loading-data">Retrieving and loading data<a class="anchor" aria-label="anchor" href="#retrieving-and-loading-data"></a>
</h3>
<p>We first need to retrieve the infections data from the fdmr example
data store and unpack it and we’ll use retrieve_tutorial_data to do
this.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fdmr</span><span class="fu">::</span><span class="fu"><a href="../reference/retrieve_tutorial_data.html">retrieve_tutorial_data</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">"covidST_mcmc"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Tutorial data extracted to  /home/runner/fdmr/tutorial_data/covidst_mcmc</span></span></code></pre>
<p>The COVID-19 data and the related covariate information are included
in our tutorial data package. We’ll load in the data using the
<code>load_tutorial_data</code> function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_covid</span> <span class="op">&lt;-</span> <span class="fu">fdmr</span><span class="fu">::</span><span class="fu"><a href="../reference/load_tutorial_data.html">load_tutorial_data</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">"covidST_mcmc"</span>, filename <span class="op">=</span> <span class="st">"st_covid.rds"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in get_tutorial_datapath(dataset = dataset, filename = filename): Unable to load data, the folder /home/runner/fdmr/tutorial_data/covidST_mcmc does not exist. Have you run retrieve_tutorial_data?</span></span></code></pre>
<p>Next we’ll use the <code>load_tutorial_data</code> function to load
in the spatial data we want.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sp_data</span> <span class="op">&lt;-</span> <span class="fu">fdmr</span><span class="fu">::</span><span class="fu"><a href="../reference/load_tutorial_data.html">load_tutorial_data</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">"covidST_mcmc"</span>, filename <span class="op">=</span> <span class="st">"spatial_data.rds"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in get_tutorial_datapath(dataset = dataset, filename = filename): Unable to load data, the folder /home/runner/fdmr/tutorial_data/covidST_mcmc does not exist. Have you run retrieve_tutorial_data?</span></span></code></pre>
<p>In this study, we use the areal unit modelling approach to fit the
BHM and then make model inference using MCMC method. To do this, we need
to construct a non-negative symmetric
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">n \times n</annotation></semantics></math>
neighbourhood or adjacency matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐖</mi><annotation encoding="application/x-tex">\boldsymbol{W}</annotation></semantics></math>
that accounts for the spatio-temporal autocorrelation structure, where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>=</mo><mn>6789</mn></mrow><annotation encoding="application/x-tex">n=6789</annotation></semantics></math>
is the number of areal units. The neighbourhood matrix specifies the
spatial closeness between pairs of areal units. The elements
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\{w_{ij}\}</annotation></semantics></math>
in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐖</mi><annotation encoding="application/x-tex">\boldsymbol{W}</annotation></semantics></math>
can be either continuous or binary, and a larger value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">w_{ij}</annotation></semantics></math>
represents that MSOAs
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(i,j)</annotation></semantics></math>
are spatially closer to each other. Here we use the border sharing
specification, so that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">w_{ij}=1</annotation></semantics></math>
if MSOAs
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(i,j)</annotation></semantics></math>
share a common geographical border, and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">w_{ij}=0</annotation></semantics></math>
otherwise.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">W_nb</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/poly2nb.html" class="external-link">poly2nb</a></span><span class="op">(</span><span class="va">sp_data</span>, row.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">sp_data</span><span class="op">@</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in eval(expr, envir, enclos): object 'sp_data' not found</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2mat.html" class="external-link">nb2mat</a></span><span class="op">(</span><span class="va">W_nb</span>, style <span class="op">=</span> <span class="st">"B"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in eval(expr, envir, enclos): object 'W_nb' not found</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="model-specification">Model specification<a class="anchor" aria-label="anchor" href="#model-specification"></a>
</h2>
<p>We use a Bayesian hierarchical model to predict the spatio-temporal
COVID-19 infection rate at the neighbourhood level in England. Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Y</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">Y_{it}</annotation></semantics></math>
denotes the weekly number of reported COVID cases for neighbourhood
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>=</mo><mn>6789</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">i=1,\ldots, n(=6789)</annotation></semantics></math>
and week
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>T</mi><mrow><mo stretchy="true" form="prefix">(</mo><mo>=</mo><mn>108</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">t=1,\ldots, T(=108)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>N</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">N_{it}</annotation></semantics></math>
denotes the (official) estimated population living in neighbourhood
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
and week
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Y</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">Y_{it}</annotation></semantics></math>
is assumed to have a Poisson distribution with parameters
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>N</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">N_{it}</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>θ</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">\theta_{it}</annotation></semantics></math>),
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>θ</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">\theta_{it}</annotation></semantics></math>
is the true unobserved COVID-19 infection rate in MSOA
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
and week
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.
We follow a standard path in modelling
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>θ</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><annotation encoding="application/x-tex">\theta_{it}</annotation></semantics></math>
with a log link to the Poisson and start with a model where the linear
predictor decomposes additively into a set of covariates and a Gaussian
Markov Random Field process, which characterises the infection of the
disease after the covariate effects have been accounted for. A general
Bayesian hierarchical model commonly specified is given by</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>Y</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="postfix">|</mo><msub><mi>N</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo>,</mo><msub><mi>θ</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mtext mathvariant="normal">Poisson</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>N</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><msub><mi>θ</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mspace width="0.222em"></mspace><mspace width="0.222em"></mspace><mi>i</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>n</mi><mo>,</mo><mi>t</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>T</mi><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>l</mi><mi>o</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>θ</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msubsup><mi>𝐱</mi><mrow><mi>𝐢</mi><mi>𝐭</mi></mrow><mi mathvariant="bold">⊤</mi></msubsup><mi>𝛃</mi><mo>+</mo><msub><mi>ϕ</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mi>.</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\nonumber  Y_{it}\vert N_{it}, \theta_{it} &amp;\sim \text{Poisson}(N_{it}\theta_{it}),\ \  i=1,\ldots,n, t=1,\ldots,T,\\
 log(\theta_{it} )&amp;=\boldsymbol{x_{it}^{\top}}\boldsymbol{\beta}+\phi_{it}. 
\end{align}</annotation></semantics></math></p>
<p>The spatial random effects
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><msub><mi>ϕ</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\{\phi_{it}\}</annotation></semantics></math>
are included in the model to account for any residual spatio-temporal
autocorrelation after adjusting for covariates
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>𝐱</mi><mrow><mi>𝐢</mi><mi>𝐭</mi></mrow></msub><annotation encoding="application/x-tex">\boldsymbol{x_{it}}</annotation></semantics></math>.
Here we utilise the spatio-temporal modelling structure proposed by
Rushworth, Lee, and Mitchell (2014) to model
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><msub><mi>ϕ</mi><mrow><mi>i</mi><mi>t</mi></mrow></msub><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\{\phi_{it}\}</annotation></semantics></math>.
It is given by</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>𝛟</mi><mn>𝟏</mn></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mtext mathvariant="normal">N</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mn>𝟎</mn><mo>,</mo><msup><mi>τ</mi><mn>2</mn></msup><mi>𝐐</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐖</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>𝛟</mi><mi>𝐭</mi></msub><mo stretchy="false" form="postfix">|</mo><msub><mi>𝛟</mi><mrow><mi>𝐭</mi><mo mathvariant="bold">−</mo><mn>𝟏</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mtext mathvariant="normal">N</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>α</mi><msub><mi>𝛟</mi><mrow><mi>𝐭</mi><mo mathvariant="bold">−</mo><mn>𝟏</mn></mrow></msub><mo>,</mo><msup><mi>τ</mi><mn>2</mn></msup><mi>𝐐</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐖</mi><mo>,</mo><mi>ρ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo>−</mo><mn>1</mn></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mspace width="0.222em"></mspace><mspace width="0.222em"></mspace><mi>t</mi><mo>=</mo><mn>2</mn><mo>,</mo><mi>…</mi><mo>,</mo><mi>T</mi><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\nonumber \boldsymbol{\phi_1}&amp;\sim \text{N}\left(\boldsymbol{0}, \tau^2\boldsymbol{ Q}(\boldsymbol{W})^{-1}\right),\\
 \boldsymbol{\phi_t}\vert\boldsymbol{\phi_{t-1}}&amp;\sim \text{N}\left(\alpha\boldsymbol{\phi_{t-1}},\tau^2\boldsymbol{Q}(\boldsymbol{W},\rho)^{-1}\right), \ \ t=2,\ldots, T,\\
\end{align}</annotation></semantics></math> where the precision matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝐐</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐖</mi><mo>,</mo><mi>ρ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\boldsymbol{Q}(\boldsymbol{W},\rho)</annotation></semantics></math>
is proposed by Leroux et al.(2000). The algebraic form of this matrix is
given by
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝐐</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>𝐖</mi><mo>,</mo><mi>ρ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>ρ</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>d</mi><mi>i</mi><mi>a</mi><mi>g</mi><mrow><mo stretchy="true" form="prefix">(</mo><mrow><mi>𝐖</mi><mn>𝟏</mn></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mi>𝐖</mi><mo stretchy="true" form="postfix">]</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mi>ρ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>𝐈</mi><mo>,</mo></mrow><annotation encoding="application/x-tex"> \boldsymbol{Q}(\boldsymbol{W},\rho)=\rho[diag(\boldsymbol{W1})-\boldsymbol{W}]+(1-\rho)\boldsymbol{I},</annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>𝟏</mn><annotation encoding="application/x-tex">\boldsymbol{1}</annotation></semantics></math>
is the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">n\times 1</annotation></semantics></math>
vector of ones, and is the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">n\times n</annotation></semantics></math>
identity matrix.
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ρ</mi><annotation encoding="application/x-tex">\rho</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
are the spatial and temporal dependence parameters, respectively, while
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>τ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\tau^2</annotation></semantics></math>
is the variance parameter.</p>
</div>
<div class="section level2">
<h2 id="define-the-model-formula">Define the model formula<a class="anchor" aria-label="anchor" href="#define-the-model-formula"></a>
</h2>
<p>In order to fit the model, a model formula needs to be defined, by
including the response in the left-hand side and the fixed and random
effects in the right-hand side. We select a few risk factors used in our
<a href="https://4dmodeller.github.io/fdmr/articles/covid.html">COVID-19
tutorial</a>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">form</span> <span class="op">&lt;-</span> <span class="va">cases</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">Population</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="va">IMD</span> <span class="op">+</span> <span class="va">perc.wb</span> <span class="op">+</span> <span class="va">perc.ba</span> <span class="op">+</span> <span class="va">age1</span> <span class="op">+</span> <span class="va">pm25</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fit-the-model">Fit the model<a class="anchor" aria-label="anchor" href="#fit-the-model"></a>
</h2>
<p>Finally, we fit the spatio-temporal model using the function
<code>ST.CARar()</code> of the package <code>CARBayesST</code> developed
by Lee (2018) <span class="citation">Lee, Rushworth, and Napier (<a href="#ref-lee2018spatio">2018</a>)</span>. We first need to organize
the COVID-19 infection and covariate data into a specific format
expected by the <code>ST.CARar()</code> function. More details can be
found in the help file of ‘ST.CARar()’. Any MSOAs without reported cases
will be stored as missing (NA) values in the data frame.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">time.points</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">st_covid</span><span class="op">$</span><span class="va">date</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">sp_data</span><span class="op">@</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  MSOA11CD <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">sp_data</span><span class="op">$</span><span class="va">MSOA11CD</span>, <span class="va">time.points</span><span class="op">)</span>,</span>
<span>  date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">st_covid</span><span class="op">$</span><span class="va">date</span><span class="op">)</span><span class="op">)</span>, each <span class="op">=</span> <span class="va">n</span><span class="op">)</span>,</span>
<span>  time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">time.points</span>, each <span class="op">=</span> <span class="va">n</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">rowid</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://edzer.github.io/sp/reference/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">st_covid</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"MSOA11CD"</span>,</span>
<span>  <span class="st">"date"</span>,</span>
<span>  <span class="st">"MSOA11NM"</span>,</span>
<span>  <span class="st">"cases"</span>,</span>
<span>  <span class="st">"Population"</span></span>
<span><span class="op">)</span><span class="op">]</span>,</span>
<span>all.x <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MSOA11CD"</span>, <span class="st">"date"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">rowid</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">covars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">st_covid</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"MSOA11CD"</span>,</span>
<span>  <span class="st">"IMD"</span>,</span>
<span>  <span class="st">"age1"</span>,</span>
<span>  <span class="st">"perc.chinese"</span>,</span>
<span>  <span class="st">"perc.indian"</span>,</span>
<span>  <span class="st">"perc.wb"</span>,</span>
<span>  <span class="st">"perc.bc"</span>,</span>
<span>  <span class="st">"perc.ba"</span>,</span>
<span>  <span class="st">"pm25"</span>,</span>
<span>  <span class="st">"no2"</span></span>
<span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://edzer.github.io/sp/reference/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">covars</span>,</span>
<span>  all.x <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MSOA11CD"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">rowid</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">pre</span> <span class="op">&lt;-</span> <span class="va">dat</span><span class="op">$</span><span class="va">cases</span> <span class="op">/</span> <span class="va">dat</span><span class="op">$</span><span class="va">Population</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">logpre</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">pre</span><span class="op">)</span></span>
<span><span class="va">nbhoods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">st_covid</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MSOA11CD"</span>, <span class="st">"Population"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co">#  this will take a few minutes</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">Population</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">dat</span><span class="op">$</span><span class="va">Population</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">nbhoods</span><span class="op">[</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span></span>
<span>        <span class="va">dat</span><span class="op">[</span><span class="va">i</span>, <span class="st">"MSOA11CD"</span><span class="op">]</span>,</span>
<span>        <span class="va">nbhoods</span><span class="op">$</span><span class="va">MSOA11CD</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="st">"Population"</span></span>
<span>    <span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">st_covid</span> <span class="op">&lt;-</span> <span class="va">dat</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">nbhoods</span>, <span class="va">out</span>, <span class="va">covars</span><span class="op">)</span> <span class="co"># remove non-necessary objects</span></span></code></pre></div>
<blockquote>
<p>:warning: <strong>Memory requirements</strong>: Running the model
requires a large amount of memory and may fail if run on a normal laptop
/ desktop.</p>
</blockquote>
<p>Now the data frame ‘st_covid’ has the expected format. Then run the
model.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">MCMC_model</span> <span class="op">&lt;-</span> <span class="fu">CARBayesST</span><span class="fu">::</span><span class="fu">ST.CARar</span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">form</span>,</span>
<span>  data <span class="op">=</span> <span class="va">st_covid</span>,</span>
<span>  family <span class="op">=</span> <span class="st">"poisson"</span>,</span>
<span>  W <span class="op">=</span> <span class="va">w</span>,</span>
<span>  burnin <span class="op">=</span> <span class="fl">10000</span>,</span>
<span>  n.sample <span class="op">=</span> <span class="fl">30000</span>,</span>
<span>  thin <span class="op">=</span> <span class="fl">10</span>, AR <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we summarise the modelling results. “fitted_vals” stores the
predicted COVID-19 infection rate at each MSOA and time point. “modfits”
stores the DIC and WAIC values, which measure the goodness of model fit.
“mod_sum” provides the values for parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mi>τ</mi><mn>2</mn></msup><annotation encoding="application/x-tex">\tau^2</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ρ</mi><annotation encoding="application/x-tex">\rho</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>α</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">MCMC_model</span><span class="op">$</span><span class="va">samples</span><span class="op">$</span><span class="va">beta</span>, <span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">MCMC_model</span><span class="op">$</span><span class="va">samples</span><span class="op">$</span><span class="va">phi</span>, <span class="fl">2</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fitted_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind.data.frame</a></span><span class="op">(</span><span class="va">st_covid</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MSOA11CD"</span>, <span class="st">"date"</span><span class="op">)</span><span class="op">]</span>, <span class="va">fitted_vals</span><span class="op">)</span></span>
<span><span class="va">modfits</span> <span class="op">&lt;-</span> <span class="va">MCMC_model</span><span class="op">$</span><span class="va">modelfit</span></span>
<span><span class="va">mod_sum</span> <span class="op">&lt;-</span> <span class="va">MCMC_model</span><span class="op">$</span><span class="va">summary.results</span></span></code></pre></div>
<p>The above modelling results are provided in the tutorial data package
so we’ll load them now.</p>
<blockquote>
<p><strong><em>NOTE:</em></strong> If you’ve run the full model above
you don’t need to load in the files below.</p>
</blockquote>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted_vals</span> <span class="op">&lt;-</span> <span class="fu">fdmr</span><span class="fu">::</span><span class="fu"><a href="../reference/load_tutorial_data.html">load_tutorial_data</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">"covidST_mcmc"</span>, filename <span class="op">=</span> <span class="st">"fitted_vals.rds"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in get_tutorial_datapath(dataset = dataset, filename = filename): Unable to load data, the folder /home/runner/fdmr/tutorial_data/covidST_mcmc does not exist. Have you run retrieve_tutorial_data?</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modfits</span> <span class="op">&lt;-</span> <span class="fu">fdmr</span><span class="fu">::</span><span class="fu"><a href="../reference/load_tutorial_data.html">load_tutorial_data</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">"covidST_mcmc"</span>, filename <span class="op">=</span> <span class="st">"modfits.rds"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in get_tutorial_datapath(dataset = dataset, filename = filename): Unable to load data, the folder /home/runner/fdmr/tutorial_data/covidST_mcmc does not exist. Have you run retrieve_tutorial_data?</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_sum</span> <span class="op">&lt;-</span> <span class="fu">fdmr</span><span class="fu">::</span><span class="fu"><a href="../reference/load_tutorial_data.html">load_tutorial_data</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">"covidST_mcmc"</span>, filename <span class="op">=</span> <span class="st">"mod_sum.rds"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in get_tutorial_datapath(dataset = dataset, filename = filename): Unable to load data, the folder /home/runner/fdmr/tutorial_data/covidST_mcmc does not exist. Have you run retrieve_tutorial_data?</span></span></code></pre>
<p>For comparison purpose, we also fit a separate BHM to the same
dataset using the INLA-SPDE approach. The infection rates predicted by
the INLA-SPDE approach is saved in the date frame named “inla_preds” and
is provided in the tutorial data package. We’ll load that in now.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inla_preds</span> <span class="op">&lt;-</span> <span class="fu">fdmr</span><span class="fu">::</span><span class="fu"><a href="../reference/load_tutorial_data.html">load_tutorial_data</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">"covidST_mcmc"</span>, filename <span class="op">=</span> <span class="st">"inla_preds.rds"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in get_tutorial_datapath(dataset = dataset, filename = filename): Unable to load data, the folder /home/runner/fdmr/tutorial_data/covidST_mcmc does not exist. Have you run retrieve_tutorial_data?</span></span></code></pre>
<p>Then the predictions from the two models are merged into one data
frame named “mergedat”.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mergedat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://edzer.github.io/sp/reference/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">inla_preds</span>,</span>
<span>  <span class="va">fitted_vals</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MSOA11CD"</span>, <span class="st">"date"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'merge': object 'inla_preds' not found</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="model-comparison">Model comparison<a class="anchor" aria-label="anchor" href="#model-comparison"></a>
</h2>
<p>We show the DIC and WAIC values for each model. The model using the
MCMC approach performs better than the model using the INLA-SPDE
approach in terms of the lower DIC and WAIC values.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inla_sum</span> <span class="op">&lt;-</span> <span class="fu">fdmr</span><span class="fu">::</span><span class="fu"><a href="../reference/load_tutorial_data.html">load_tutorial_data</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">"covidST_mcmc"</span>, filename <span class="op">=</span> <span class="st">"INLAmodsum.rds"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in get_tutorial_datapath(dataset = dataset, filename = filename): Unable to load data, the folder /home/runner/fdmr/tutorial_data/covidST_mcmc does not exist. Have you run retrieve_tutorial_data?</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modfit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  DIC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">modfits</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">inla_sum</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  WAIC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">modfits</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">inla_sum</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in eval(expr, envir, enclos): object 'modfits' not found</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">modfit</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MCMC"</span>, <span class="st">"INLA_SPDE"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error: object 'modfit' not found</span></span></code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">modfit</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in eval(expr, envir, enclos): object 'modfit' not found</span></span></code></pre>
<p>Now we compare the posterior COVID-19 infection rate estimates
between the two models. In general, the two models provide similar
posterior COVID-19 infection rate estimates.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mergedat</span><span class="op">$</span><span class="va">mcmc.fitted.prev</span>, <span class="va">mergedat</span><span class="op">$</span><span class="va">inla.fitted.prev</span>, xlab <span class="op">=</span> <span class="st">"MCMC"</span>, ylab <span class="op">=</span> <span class="st">"INLA_SPDE"</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.06</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.06</span><span class="op">)</span>, cex <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in h(simpleError(msg, call)): error in evaluating the argument 'x' in selecting a method for function 'plot': object 'mergedat' not found</span></span></code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html" class="external-link">boxplot</a></span><span class="op">(</span><span class="va">mergedat</span><span class="op">$</span><span class="va">mcmc.fitted.prev</span>, <span class="va">mergedat</span><span class="op">$</span><span class="va">inla.fitted.prev</span>,</span>
<span>  names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MCMC"</span>, <span class="st">"INLA_SPDE"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in eval(expr, envir, enclos): object 'mergedat' not found</span></span></code></pre>
<p>The regression coefficients estimates of the selected covariates for
both models are compared.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">summary_fixed</span> <span class="op">&lt;-</span> <span class="fu">fdmr</span><span class="fu">::</span><span class="fu"><a href="../reference/load_tutorial_data.html">load_tutorial_data</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">"covidST_mcmc"</span>, filename <span class="op">=</span> <span class="st">"INLAfixed_sum.rds"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in get_tutorial_datapath(dataset = dataset, filename = filename): Unable to load data, the folder /home/runner/fdmr/tutorial_data/covidST_mcmc does not exist. Have you run retrieve_tutorial_data?</span></span></code></pre>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">regr_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind.data.frame</a></span><span class="op">(</span></span>
<span>  <span class="st">"MCMC"</span> <span class="op">=</span> <span class="va">mod_sum</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">6</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>  <span class="st">"INLA_SPDE"</span> <span class="op">=</span> <span class="va">summary_fixed</span><span class="op">$</span><span class="va">mean</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in eval(expr, envir, enclos): object 'mod_sum' not found</span></span></code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">regr_est</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in eval(expr, envir, enclos): object 'regr_est' not found</span></span></code></pre>
<p>Finally, the spatial patterns of the average infection rate estimates
over time for each model are displayed below.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mcmc_mean_rate</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">mergedat</span>, <span class="va">MSOA11CD</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>  mean.rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mcmc.fitted.prev</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in eval(expr, envir, enclos): object 'mergedat' not found</span></span></code></pre>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sp_data</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">mcmc_mean_rate</span> <span class="op">&lt;-</span> <span class="va">mcmc_mean_rate</span><span class="op">$</span><span class="va">mean.rate</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in eval(expr, envir, enclos): object 'mcmc_mean_rate' not found</span></span></code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">domain</span> <span class="op">&lt;-</span> <span class="va">sp_data</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">mcmc_mean_rate</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in eval(expr, envir, enclos): object 'sp_data' not found</span></span></code></pre>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fdmr</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_map.html">plot_map</a></span><span class="op">(</span></span>
<span>  polygon_data <span class="op">=</span> <span class="va">sp_data</span>,</span>
<span>  domain <span class="op">=</span> <span class="va">domain</span>,</span>
<span>  palette <span class="op">=</span> <span class="st">"Reds"</span>,</span>
<span>  legend_title <span class="op">=</span> <span class="st">"Rate"</span>,</span>
<span>  add_scale_bar <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  polygon_fill_opacity <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  polygon_line_colour <span class="op">=</span> <span class="st">"transparent"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in eval(expr, envir, enclos): object 'sp_data' not found</span></span></code></pre>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">INLA_mean_rate</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">mergedat</span>, <span class="va">MSOA11CD</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>  mean.rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">inla.fitted.prev</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in eval(expr, envir, enclos): object 'mergedat' not found</span></span></code></pre>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sp_data</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">INLA_mean_rate</span> <span class="op">&lt;-</span> <span class="va">INLA_mean_rate</span><span class="op">$</span><span class="va">mean.rate</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in eval(expr, envir, enclos): object 'INLA_mean_rate' not found</span></span></code></pre>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">domain</span> <span class="op">&lt;-</span> <span class="va">sp_data</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">INLA_mean_rate</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in eval(expr, envir, enclos): object 'sp_data' not found</span></span></code></pre>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">fdmr</span><span class="fu">::</span><span class="fu"><a href="../reference/plot_map.html">plot_map</a></span><span class="op">(</span></span>
<span>  polygon_data <span class="op">=</span> <span class="va">sp_data</span>,</span>
<span>  domain <span class="op">=</span> <span class="va">domain</span>,</span>
<span>  palette <span class="op">=</span> <span class="st">"Reds"</span>,</span>
<span>  legend_title <span class="op">=</span> <span class="st">"Rate"</span>,</span>
<span>  add_scale_bar <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  polygon_fill_opacity <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  polygon_line_colour <span class="op">=</span> <span class="st">"transparent"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in eval(expr, envir, enclos): object 'sp_data' not found</span></span></code></pre>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-lee2018spatio" class="csl-entry">
Lee, Duncan, Alastair Rushworth, and Gary Napier. 2018.
<span>“Spatio-Temporal Areal Unit Modeling in r with Conditional
Autoregressive Priors Using the CARBayesST Package.”</span> <em>Journal
of Statistical Software</em> 84: 1–39.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/gareth-j/" class="external-link">Gareth Jones</a>, <a href="https://www.researchgate.net/profile/Xueqing_Yin" class="external-link">Xueqing Yin</a>, <a href="https://mnky9800n.github.io/" class="external-link">John Aiken</a>, Jonathan Bamber.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
