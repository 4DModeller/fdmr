

# Load in the data

```{r, eval=FALSE}
fdmr::retrieve_tutorial_data(dataset = "covid")
sp_data <- fdmr::load_tutorial_data(dataset = "covid", filename = "spatial_data.rds")
covid19_data <- fdmr::load_tutorial_data(dataset = "covid", filename = "covid19_data.rds")
```

# Subset data

## Reduce extent of spatial data

Here we trim the spatial data to within a bounding box around Bristol.

A bigger box
```{r, eval=FALSE}
long_min <- -2.695726
long_max <- -2.400219
lat_min <- 51.390799
lat_max <- 51.521310
```

A smaller box

```{r, eval=FALSE}
lat_min <- 51.442511
lat_max <- 51.471274
long_min <- -2.620198
long_max <- -2.550427
```

```{r, eval=FALSE}
bounding_vals <- c(long_min, long_max, lat_min, lat_max)
sp_data_bristol <- raster::crop(sp_data, raster::extent(bounding_vals))
```

## Trim the COVID-19 observation data

Now we filter the COVID-19 data so we only have data from within our bounding box.

```{r, eval=FALSE}
covid19_data_bris <- dplyr::filter(covid19_data, LONG >= long_min, LONG <= long_max, LAT >= lat_min, LAT <= lat_max)
```

# Create the mesh

> **_NOTE:_**  Should we let the user pass in a mesh here? At the moment the app just creates one for them using the params from the COVID-19 tutorial.

We can have a look at the mesh and change it interactively using the `mesh_builder` Shiny app. Using the app I came up with a mesh with the following parameters, we'll use this
and pass it into the Setting Priors Shiny app below.

```{r, eval=FALSE}
mesh <- INLA::inla.mesh.2d(loc = sp_data_bristol@data[, c("LONG", "LAT")],
          max.edge = c(0.1, 0.4),
          offset = c(0.0042915, 0.0171660),
          cutoff = c(0.01428571, 0.05714286))
```

In order to fit the model, we also need to define a temporal index (must be an integer starting at 1) and the number of discrete time points we want to model.

```{r, error=TRUE, eval=FALSE}
group_index <- covid19_data_bris$week
n_groups <- length(unique(covid19_data_bris$week))
```

# Set coordinates on data

We will use the function `bru()` of package `inlabru` to fit the model. `bru` expects the coordinates of the data, thus we transform `covid19_data_bris` data set to a SpatialPointsDataFrame using the function `coordinates()` of the `sp` package.

```{r, error=TRUE, eval=FALSE}
sp::coordinates(covid19_data_bris) <- c("LONG", "LAT")
```

# Define how the process evolves over time and set prior for the temporal parameter

```{r pccor, error=TRUE, eval=FALSE}
rhoprior <- list(theta = list(prior = "pccor1", param = c(0, 0.9)))
```

# Use the Explore Priors Shiny app

Now we have the filtered data we are ready to pass in the spatial 

First start by selecting the variable to model. In this example we'll select `cases`, then select the features to add to the formula. At the bottom of the window you'll see the formula being constructed.
Click on the checkboxes to select your formula and then click the `Run Model` button to run the model see it's output plot on the right of the window.

```{r eval=FALSE}
fdmr::interactive_priors(spatial_data = sp_data_bristol, measurement_data = covid19_data_bris, mesh=mesh)
```


# Check the results

```{r summarymodel, error=TRUE, eval=FALSE}
model_summary <- summary(inlabru_model)

model_summary_fixed <- inlabru_model$summary.fixed
model_hyperparams <- inlabru_model$marginals.hyperpar
```