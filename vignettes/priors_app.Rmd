# Load in the data

```{r}
fdmr::retrieve_tutorial_data(dataset = "covid")
sp_data <- fdmr::load_tutorial_data(dataset = "covid", filename = "spatial_data.rds")
covid19_data <- fdmr::load_tutorial_data(dataset = "covid", filename = "covid19_data.rds")
```

# Subset data

## Reduce extent of spatial data

Here we trim the spatial data to within a bounding box around Bristol.

```{r}
long_min <- -2.695726
long_max <- -2.400219
lat_min <- 51.390799
lat_max <- 51.521310
```

```{r}
bounding_vals <- c(long_min, long_max, lat_min, lat_max)
sp_data_bristol <- raster::crop(sp_data, raster::extent(bounding_vals))
```

## Trim the COVID-19 observation data

Now we filter the COVID-19 data so we only have data from within our bounding box.

```{r}
covid19_data_bris <- dplyr::filter(covid19_data, LONG >= long_min, LONG <= long_max, LAT >= lat_min, LAT <= lat_max)
```

# Create the mesh

## COVID-19 tutorial mesh

This is the mesh used in the COVID-19 tutoral.

```{r createmesh, error=TRUE}
initial_range <- diff(range(sp_data_bristol@data[, "LONG"])) / 5

max_edge <- initial_range / 8

mesh <- INLA::inla.mesh.2d(
  loc = sp_data_bristol@data[, c("LONG", "LAT")],
  max.edge = c(1, 2) * max_edge,
  offset = c(initial_range / 4, initial_range),
  cutoff = max_edge / 7
)
```

## Mesh created using `mesh_builder`

We can have a look at the mesh and change it interactively using the `mesh_builder` Shiny app. Using the app I came up with a mesh with the following parameters, we'll use this
and pass it into the Setting Priors Shiny app below.

```{r}
mesh <- inla.mesh.2d(loc = sp_data_bristol,
          max.edge = c(0.02, 0.1),
          cutoff = 0.005,
          offset = c(0.1, 0.3))
```

In order to fit the model, we also need to define a temporal index (must be an integer starting at 1) and the number of discrete time points we want to model.

```{r, error=TRUE}
group_index <- covid19_data_bris$week
n_groups <- length(unique(covid19_data_bris$week))
```

We will use the function `bru()` of package `inlabru` to fit the model. `bru` expects the coordinates of the data, thus we transform `covid19_data_bris` data set to a SpatialPointsDataFrame using the function `coordinates()` of the `sp` package.

```{r, error=TRUE}
sp::coordinates(covid19_data_bris) <- c("LONG", "LAT")
```

# Define how the process evolves over time and set prior for the temporal parameter

```{r pccor, error=TRUE}
rhoprior <- list(theta = list(prior = "pccor1", param = c(0, 0.9)))
```

# Use the Explore Priors Shiny app

Now we have the filtered data we are ready to pass in the spatial 

# TODO

- Pass in spatial data, pass in measurement data

- Add mesh building function
- Add SPDE building function
- 

# Define the model formula

In order to fit the spatio-temporal model, a model formula needs to be defined, by including the response in the left-hand side and the fixed and random effects in the right-hand side.
In the Shiny app you can dynamically control the formula used by selecting variables using the checkboxes.

First start by entering the initial part of the formula, which in this example defaults to `cases ~ 0 + Intercept`. Click on the checkboxes to select your formula and then click the `Run Model` button to
run the model see it's output plot on the right of the window.

```{r}
fdmr::interactive_priors(spatial_data = sp_data_bristol, measurement_data = covid19_data_bris)
```



# Check the results

```{r summarymodel, error=TRUE, eval=FALSE}
model_summary <- summary(inlabru_model)

model_summary_fixed <- inlabru_model$summary.fixed
model_hyperparams <- inlabru_model$marginals.hyperpar
```