---
title: "Priors Shiny App"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Priors Shiny App}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

We first need to retrieve the data from the fdmr example data store and unpack it and we'll use `retrieve_tutorial_data` to do this.

```{r}
fdmr::retrieve_tutorial_data(dataset = "priors")
```

Next we'll use the `load_tutorial_data` function to load in the spatial data we want.

```{r loadshape, error=TRUE}
sp_data <- fdmr::load_tutorial_data(dataset = "priors", filename = "spatial_dataBris.rds")
```

Now we make a map of the study region.
load
```{r rmap, error=TRUE,fig.cap="A map of the study region.", fig.width=8, fig.height=4, fig.align='center'}
sp_data@data$mapp <- 0
domain <- sp_data@data$mapp
fdmr::plot_map(polygon_data = sp_data, domain = domain, add_scale_bar = TRUE, polygon_fill_opacity = 0.5, palette = "YlOrRd")
```

The COVID-19 data in Bristol are included in our tutorial data package. We'll load in the data using same process we used above

```{r loadCOVIDat, error=TRUE}
covid19_data <- fdmr::load_tutorial_data(dataset = "priors", filename = "covid19_dataBris.rds")
```

Then the first 6 rows of the data set can be viewed using the following code

```{r , error=TRUE}
utils::head(covid19_data)
```

# Create the mesh

We can have a look at the mesh and change it interactively using the `mesh_builder` Shiny app. Using the app I came up with a mesh with the following parameters, we'll use this
and pass it into the Setting Priors Shiny app below.

```{r createmesh, error=TRUE}
initial_range <- diff(base::range(sp_data@data[, "LONG"])) / 3
max_edge <- initial_range / 2
mesh <- INLA::inla.mesh.2d(
  loc = sp_data@data[, c("LONG", "LAT")],
  max.edge = c(1, 2) * max_edge,
  offset = c(initial_range, initial_range),
  cutoff = max_edge / 7
)
```

In order to fit the model, we also need to define a temporal index (must be an integer starting at 1) and the number of discrete time points we want to model. The app will do this for us, we just need to tell it which time variable to use, here we use `week`.

```{r, error=TRUE, eval=FALSE}
time_variable <- "week"
```

# Set coordinates on data

We will use the function `bru()` of package `inlabru` to fit the model. `bru` expects the coordinates of the data, thus we transform `covid19_data_bris` data set to a `SpatialPointsDataFrame` using the function `coordinates()` of the `sp` package.

```{r, error=TRUE, eval=FALSE}
sp::coordinates(covid19_data) <- c("LONG", "LAT")
```

# Use the Explore Priors Shiny app

Now we have the filtered data we are ready to pass in the spatial 

First start by selecting the variable to model. In this example we'll select `cases`, then select the features to add to the formula. At the bottom of the window you'll see the formula being constructed.
Click on the checkboxes to select your formula and then click the `Run Model` button to run the model see it's output plot on the right of the window.

```{r eval=FALSE}
fdmr::interactive_priors(spatial_data = sp_data, measurement_data = covid19_data, time_variable="week", mesh=mesh)
```


# Check the results

```{r summarymodel, error=TRUE, eval=FALSE}
model_summary <- summary(inlabru_model)

model_summary_fixed <- inlabru_model$summary.fixed
model_hyperparams <- inlabru_model$marginals.hyperpar
```